# MIUI小组件开发分享（草稿）

大家好，我是李唐，目前是一位独立开发者，在维护的作品包括[钱迹](https://qianjiapp.com/)等 App。今天主要想和大家聊聊的话题是 Android 系统的「小组件」。

小米手机从 MIUI 13 开始增加了独立的[小部件](https://dev.mi.com/console/doc/detail?pId=2466)（Widget）系统，受到不少 MIUI 用户的好评。钱迹则在 2022 年 1 月进行了适配，算是比较早一批跟进相关特性的应用。因为占据了一些时间红利，MIUI 13 小部件适配也为钱迹带来了不少新增用户。所以在此分享一下我们适配过程中的一些感受，希望可以对大家有所帮助。

因为有完整的技术文档，本文不展开讨论技术细节、仅分享适配体验。如果文章中有错误烦请指出，谢谢！

## Android 原生小组件的问题
很多人可能不知道的是，Android 系统的小组件支持最早可以追溯到 2008 年 10 月发布的首个版本，Google 在 2009 年的 Android 1.5 中向第三方开发者开放了小组件开发，在 2011 年的 Android 4.0 中，支持滚动、交互和尺寸调节的新版小组件面世，现代 Android 操作系统中的小组件系统基础也就此奠定。值得一提的是，推出不到一年、但已经广受开发者支持的 iOS 锁屏小组件，Android 这边早在 2012 年的 Android 4.2 版本中探索过了。

![image](https://github.com/litang0908/litang0908.github.io/assets/34314096/5eaf19ec-2241-45a7-8c98-987a35090046)

这里提 iOS 的小组件并非是想拉踩，而是 Google 在小组件这件事情上确实有很多考虑步骤的地方，即便对比本文开头替代的 MIUI 也是如此。事实上，直到 Android 12 之前，Android 小组件在我看来都可以说是处在「半成品」状态，从开发者的角度而言我们有非常多的痛点无法解决，再加上 Android 本身比较割裂的生态，会发现一些方法或者属性无效。

这里的「方法和属性」反映到用户最终的小组件使用体验，最主要的表现就是小组件的尺寸问题。举个例子，早前如果我们按照 Google 的官方文档开发小组件，这个小组件在不同厂商的手机上所呈现出来的尺寸大概率各不相同，同一个小组件在 4x5 和 5x6 的桌面中宽高比也完全不一样。

【因为后面讲到了 MIUI 小组件在这方面的处理，所以如果可能的话，请尽量补充说明一下具体是哪一部分的开发规范不完善导致的尺寸问题——或者说从开发者的角度来说，在小组件尺寸这件事情上你认为怎样的开发规范才更合理、更易用？】

说直白一点——我们甚至很难保证给所有 Android 用户一个通用的、正方形的 app 小组件。这种体验对用户而言也比较糟心，当他们将不同 App 的同尺寸小组件放在一起时，这些小组件无法对齐一直以来也是常态。而我们在经历了多轮尝试后，最终也放弃了尺寸统一，转而选择以 `MATCH_PARENT` 的方式交给手机自行去处理。尽管这种方法在某些机型上又会导致小组件比例异常。

遗憾地是，虽然 Android 12 对小组件做了[大量改进](https://developer.android.com/about/versions/12/features/widgets)，但尺寸统一问题依然没能解决。

## MIUI 小组件做对了什么

MIUI 13 正式推出小组件（它们官方称作小部件，这里统一称为小组件）没多久，钱迹就尝试进行了适配。从技术原理上来说，MIUI 小组件本质上还是基于 Android 系统的原生小组件的，但 MIUI 在 Google 的基础上带来了不少改进。根据我们的适配经历，我总结了以下几点异同。

**首先是相同点，MIUI 小组件继承自原生 Android 的 `AppWidgetProvider`，核心代码可共用一套**。所以尽管在普通用户看来 MIUI「放弃」原生小组件的做法是在「造轮子」，但对开发者而言却并没有因此新增太多额外工作；MIUI 小组件的主要开发成本其实在审核，这个我们马上会聊到。

二者的差异就比较多了。

**MIUI 小组件有着更严格的尺寸规范。**有 2×1、2×2、4×2、4×4 四种尺寸，所以在小米手机上的呈现比例也会完全一致，这一点类似 iPhone。

【这里需要补充一下更多信息，尺寸上的限制是原生 Android 没有的吗？会不会是因为小米内部的机型所采用的启动器固定（国产厂商也不怎么鼓励用户切换启动器）所以也有帮助？如果可能的话请补充一下。】

**MIUI 小组件依赖独立进程进行运作。**为了节省内存占用，MIUI 小组件单独交由 `widgetProvider` 进程管理。

【同样的，原生 Android 是如何管理 widget 资源的、管理方式有何问题？如果可能请为普通读者稍微扩展一下。】

**在小组件的刷新机制方面，MIUI 小组件也做得十分细致。**开发者可选择在 App 内主动通过代码刷新，或在桌面切换页面时自动触发刷新。

【原生 Android 提供的刷新方式够多吗？如果要体现这种机制的灵活性，其实可以简单聊聊不同的刷新机制对开发者而言有何好处，比如钱迹可以选择了哪种刷新机制，而如果读者是其他类型 app 的用户/开发者，他们又可以选择哪种刷新机制。】

**MIUI 小组件与原生小组件的分离设计，对开发者而言也十分巧妙。**小米为 MIUI 小组件提供了独立的小组件中心，用户可以浏览大量优秀的小组件，这也造就了一个不小的流量入口；Android 原生的小组件入口则被放置在小组件中心底部并不明显的位置，很明显，MIUI 小组件的目的就是要取代原生小组件。

**最后则是上面提到的、相对严格的小组件审核机制。**MIUI 小组件必须经过审核才能上线并被用户搜索、添加。审核时，小米审核人员会对布局、圆角、UI 规范等细节严格把控，所以流程上可能会比较繁琐。

【相比之下 Google 和 Play 商店这边则几乎是不管不顾的状态了，这部分如果你那边没有点评的话我后面也可以再补充一点。】

## 给开发者的注意事项

### 1.邮件申请
开发前需要邮件联系 MIUI 官方（参见 [链接](https://dev.mi.com/console/doc/detail?pId=2466#_5)），留下你的联系信息后，他们会拉微信群进行对接，所需的资料和细节都会在微信群沟通。

### 2.版本更新
每次小组件如果有改动，均需要更新 App 内的小组件版本号，同时发送邮件提交审核，等审核过后用户才可以在 App 内使用。

这一点务必注意，我们之前就出现过因为小组件未审核通过，而给用户分发了新版本，导致用户无法使用小组件的情况。

参见[《小部件版本号》](https://dev.mi.com/console/doc/detail?pId=2479#_2_9)

### 3.关于审核
- MIUI 的设计规范审核是相当严格的，流程参考下图；如果不符合 MIUI 设计规范则审核失败。
- 需填写详细的审核资料，包括截图、描述、预览图、无障碍、功耗等多个方面，建议自行测试后再提交。
- 请做好功耗测试。这一步比较繁琐，需要跑较长时间的脚本来完成，小米方面可能也是担心一些小组件太耗电，总体而言倒也能接受（开发时官方会给完整的测试教程）。

![11 17提测流程](https://github.com/litang0908/work-log/assets/44760239/dc6df9b1-e1d7-4298-84cc-b6db906d3f1c)

审核过程需要的物料清单如下：

1. 提测的apk
2. 小部件素材-小部件浅色模式预览图
3. 小部件素材-小部件深色模式预览图（没有适配深色模式则无需提供）
4. 小部件素材-应用图标
5. 测试报告
6. 284log

### 4.版本延误
这个问题在我们后续更新中发现，其中有一次提交审核后，几乎等了一个月才通过审核，跟 MIUI 官方沟通才知道他们审核人力有限只能按照优先级来处理，我们能做的只有等待。这也导致我们现在对 MIUI 小组件的改动非常谨慎，轻易不做升级了。

这里肯定也有人会问，如果改动后不提交审核，直接发布 App 会怎样？

如果改了小组件的尺寸或者文字大小，其实系统能够检测得到，而未提交小组件审核，那么用户安装新版后，小组件中心是找不到改动后的小组件的（已经添加在桌面的不影响）。

### 5.适配收益

就 MIUI 小组件的适配过程而言，技术方面其实没有什么难点，按照 MIUI 提供的文档基本上都能完成。不过文档比较细碎，建议开发前先大致浏览一遍。在我看来最大的问题还是在审核，我们也踩了不少坑——不过也能理解，这种严苛的审核流程一定程度上也保证了 MIUI 小组件的高质量。

钱迹在适配完 MIUI 小组件后很顺利地进入了 MIUI 小组件中心首页，甚至也获得过几次 MIUI 官方微博的推荐。上线后的一年中，钱迹在小米应用市场的下载量翻了三倍，这种几乎零成本的运营方式，对个人或者小团队而言都是极佳的机会。

下图是钱迹在小米应用市场的每日安装增长情况，可以看出适配小组件后下载量明显上升：

<img width="868" alt="钱迹在小米应用市场的下载变化" src="https://github.com/litang0908/work-log/assets/44760239/fe3435b1-5223-4ebe-a199-4e4a329ba188">

## 结尾

之前也有朋友问我要不要适配 MIUI 小组件，我的结论是，如果有足够耐心，还是尽量适配一下。一是为用户提供相比原生更舒适的体验，这是产品力的体现；二是 MIUI 在国内拥有庞大的用户群，在小组件中心得到的曝光机会，甚至比在应用市场更多。

谁会拒绝免费的流量呢？即便它审核繁琐、规则较多，但如果收益大于产出，那适配是毫不犹豫的选择了。

## 参考资料
[Android App widgets overview](https://developer.android.com/develop/ui/views/appwidgets/overview)

[Provide flexible widget layouts](https://developer.android.com/develop/ui/views/appwidgets/layouts)

[MIUI小部件开发者平台](https://widget.xiaomi.com/)

[MIUI小部件规范](https://dev.mi.com/console/doc/detail?pId=2466)

[MIUI小部件技术规范](https://dev.mi.com/console/doc/detail?pId=2479)
