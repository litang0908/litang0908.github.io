# MIUI小组件开发分享（草稿）

大家好，我是李唐，目前是一位独立开发者，目前维护的作品有钱迹等App。

小米手机从 MIUI 13 开始，增加了独立的小组件（Widget）系统，引来不少 MIUI 用户的好评，而钱迹在 2022年01月份也参与了适配，算是比较早一批适配的开发者，因此占据了一些时间红利，为钱迹带来不少新增用户。所以在此分享一下我们适配过程中的一些感受，希望可以对大家有所帮助。

因为有完整的技术文档，这里就不展开技术细节了，仅讨论一下适配体验，如果文章中有错误，烦请指出，谢谢！

## Android 原生小组件的问题
其实 Android 系统的桌面组件从 4.0 版本开始就有了，但是一直到 Android 12 之前，Android 小组件在我看来，都是一个半成品，有非常多的痛点无法解决。再加上 Android 本身就比较割裂的生态，你会发现一些方法或者属性无效。

当然，最主要的，还是尺寸问题：

按照官方文档实现的小组件，在不同厂商手机上，尺寸不同，你甚至很难实现一个通用的正方形小组件，又比如同一个小组件，在 4x5 和 5x6 的桌面中，宽高比完全不一样。

因此，我们就能看到不同 App 开发的同尺寸小组件放一起时，无法对齐。在经历了多轮尝试后，我们最终放弃尺寸统一，以 `MATCH_PARENT` 的方式，交给手机自行去处理（这在一些机型上显得比例异常）。

遗憾地是，虽然 Android 12 对小组件做了大量改进，但是尺寸统一问题依然没能解决。

改进细节可以参考 [《Android 12 widgets improvements》](https://developer.android.com/about/versions/12/features/widgets)

## MIUI 小组件的出现

MIUI 13 正式推出的小组件（它们官方称作小部件，这里统一称为小组件）没多久，钱迹就尝试进行适配，从技术原理来说，本质是基于 Android 系统的 Widget，同时也带来不少的改进，根据我们的适配经历，总结的相同和差异有以下几点：

### 相同点：
- 均继承自 `AppWidgetProvider` 所以核心代码共用一套即可。

### 区别
- 严格的尺寸规范：有 2*1、2*2、4*2、4*4 四种尺寸，所以在所有小米手机上，比例完全一致，这一点类似 iPhone。
- 使用独立进程：为了节省内存占用，所以 MIUI 小组件单独在`:widgetProvider`进程中。
- 更细致的刷新机制：不仅可以在 App 内主动通过代码刷新，也支持在桌面切换页面时，自动触发刷新机制。
- 与原生小组件分离：小米提供了独立的小组件中心，用户可以浏览大量优秀的小组件，这也造就了一个不小的流量入口。而 Android 原生的小组件入口，则被放置在小组件中心底部并不明显的位置，很明显，MIUI 小组件的目的就是要取代原生小组件。
- 需单独审核：MIUI 小组件如果想要被用户添加到，必须经过审核才能上线，审核时，小米审核人员，会对布局、圆角、UI 规范严格，这一点可能会比较繁琐。

## 注意事项

### 1.邮件申请
开发前需要邮件联系 MIUI 官方（参见 [链接](https://dev.mi.com/console/doc/detail?pId=2466#_5)），留下你的联系信息后，他们会拉微信群进行对接，所需的资料和细节，都会在微信群沟通。

### 2.版本更新
每次小组件如果有改动，均需要更新 App 内的小组件版本号，同时发送邮件提交审核，等审核过后，用户才可以在 App 内使用，这一点务必注意，我们之前就出现过因为小组件未审核通过，而给用户分发了新版本，导致用户无法使用小组件的情况。

参见[《小部件版本号》](https://dev.mi.com/console/doc/detail?pId=2479#_2_9)

### 3.审核严格
- 严格的设计规范，如果不符合 MIUI 设计规范，则审核失败。
- 需填写详细的审核资料，从截图、描述、预览图、无障碍、功耗等多个方面需要自行测试后再提交。
- 功耗测试，这一步比较繁琐，需要跑较长时间的脚本来完成，不过小米可能也是为了担心一些小组件太耗电，倒也能接受（开发时官方会给完整的测试教程）。

### 4.审核较慢，容易造成版本延误
这个问题在我们后续更新中发现，其中有一次提交审核后，几乎等了一个月才通过审核，跟 MIUI 官方沟通，他们审核人力有限，只能按照优先级来处理，所以只能等待，这也导致我们现在对改动 MIUI 非常谨慎，轻易不做升级改动了。

那么，肯定有人会问，如果改动后，不提交审核，直接发布 App 会怎样？

如果改了小组件的尺寸或者文字大小，其实系统能够检测得到，而未提交小组件审核，那么用户安装新版后，小组件中心是找不到改动后的小组件的（已经添加在桌面的不影响）。

## MIUI 小组件审核流程
![11 17提测流程](https://github.com/litang0908/work-log/assets/44760239/dc6df9b1-e1d7-4298-84cc-b6db906d3f1c)

## 审核物料清单
1. 提测的apk
2. 小部件素材-小部件浅色模式预览图
3. 小部件素材-小部件深色模式预览图（没有适配深色模式则无需提供）
4. 小部件素材-应用图标
5. 测试报告
6. 284log

## 适配 MIUI 小组件的收益

在适配 MIUI 小组件的过程中，技术方面没有什么难点，按照 MIUI 提供的文档，基本上都能完成，不过文档比较细碎，建议开发前先大致浏览一遍。但是最大的问题还是在审核阶段，我们也踩了不少坑，不过也能理解，这种严苛的审核，一定程度上，也保证了小组件中心的高质量。

在适配完 MIUI 小组件后，很顺利地进入了 MIUI 小组件中心首页，甚至也获得了几次 MIUI 官方微博的推荐，上线后的一年中，钱迹在小米应用市场的下载量翻了三倍，这种几乎零成本的运营方式，对个人或者小团队而言，绝对是极佳的机会。

下图是钱迹在小米应用市场的每日安装增长情况，从适配小组件后，下载量明显上升。

<img width="868" alt="钱迹在小米应用市场的下载变化" src="https://github.com/litang0908/work-log/assets/44760239/fe3435b1-5223-4ebe-a199-4e4a329ba188">

## 结尾

之前也有朋友问我要不要适配MIUI小组件，我的结论是，如果有足够耐心，还是尽量适配一下，一是为用户提供相比原生更舒适的体验，这也是产品力的体现，二是 MIUI 在国内拥有庞大的用户群，在小组件中心得到的曝光机会，甚至比在应用市场更多，三是谁会拒绝免费的流量呢？

即便它的审核繁琐，规则比较多，但是如果收益大于产出，那适配是毫不犹豫的选择了。

## 参考资料
[Android App widgets overview](https://developer.android.com/develop/ui/views/appwidgets/overview)

[Provide flexible widget layouts](https://developer.android.com/develop/ui/views/appwidgets/layouts)

[MIUI小部件开发者平台](https://widget.xiaomi.com/)

[MIUI小部件规范](https://dev.mi.com/console/doc/detail?pId=2466)

[MIUI小部件技术规范](https://dev.mi.com/console/doc/detail?pId=2479)
